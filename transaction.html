<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
		<link rel="stylesheet" href="themes/mytheme.css" />
  		<link rel="stylesheet" href="themes/jquery.mobile.icons.min.css" />
		<link rel="stylesheet" href="jquery.mobile-1.4.5/jquery.mobile-1.4.5.min.css">
		<script src="jquery-2.1.4.min.js"></script>
		<script src="jquery.mobile-1.4.5/jquery.mobile-1.4.5.min.js"></script>
		<script src="cordova.js"></script>
		<script>
			function sendRequest(u){
					var obj=$.ajax({url:u,async:false});
					var result=$.parseJSON(obj.responseText);
					return result;	//return object
			}

			var transid;
			var tdate;
			var timeT;
			var prodId;

			function addSale(){
				var s=transid;
				var n=$("#pname").html();
				var pr=$("#price").html();
				var q=$("#qty").val();
				alert(q);
				var strUrl = "http://cs.ashesi.edu.gh/~csashesi/class2016/agatha-maison/MWC/response.php?cmd=7&sid="+s+
					"&pname="+n+"&price="+pr+"&qty="+q+"&pid="+prodId;
				var objResult=sendRequest(strUrl);
				if(objResult.result==1){
					alert("successfully saved.");
				}

				var dis="";
				dis += "<a href='#'' class='ui-shadow ui-btn ui-corner-all ui-btn-inline ui-btn-icon-left ui-icon-star' onclick='addTrans()'>Done</a>";
				$("#btn").html(dis);

				receipt();
		}

		function addTrans(){
			var s = transid;			
			var p=pnum.value;
				var strUrl = "http://cs.ashesi.edu.gh/~csashesi/class2016/agatha-maison/MWC/response.php?cmd=8&sid="+s+"&pnum="+p+"&date="+tdate+"&time="+timeT;
				var objResult=sendRequest(strUrl);
				if(objResult.result==1){
					alert("successfully saved.");
				}
		}
		

		function genId(){
			var strUrl = "http://cs.ashesi.edu.gh/~csashesi/class2016/agatha-maison/MWC/response.php?cmd=6";
			var objResult=sendRequest(strUrl);
			if(objResult.result==1){
				transid = objResult.pass;
			}
		}

		$(document).ready(genId());

		function scan(){
			// var strUrl = "response.php?cmd=4&pid="+1;
	  //               var objResult=sendRequest(strUrl);
			// 		if(objResult.result==1){
			// 			// alert(objResult.product[0]['pname']);
			// 			$("#pname").html(objResult.product[0]['pname']);
			// 			$("#price").html(objResult.product[0]['price']);
			// 		}
			cordova.plugins.barcodeScanner.scan(
	      		function (result) {
	      			prodId = result.text;	                
	                var strUrl = "http://cs.ashesi.edu.gh/~csashesi/class2016/agatha-maison/MWC/response.php?cmd=4&pid="+prodId;
	                var objResult=sendRequest(strUrl);
					if(objResult.result==1){
						// alert("successful.");
						$("#pname").val(objResult.product[0]['pname']);
						$("#price").val(objResult.product[0]['price']);						
					}
	      		}, 
	      		function (error) {
	          		alert("Scanning failed: " + error);
	      		}
   			);
		}

		function setDate(){
			var d = new Date();
			tdate = d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate();
			timeT = d.getHours()+":"+d.getMinutes()+":"+d.getSeconds();
			$("#date").html(tdate);
			$("#time").html(timeT);
		}

		function receipt(){
			setDate();

			var id=transid;
			var strUrl = "http://cs.ashesi.edu.gh/~csashesi/class2016/agatha-maison/MWC/response.php?cmd=9&sid="+id;
			alert(id);
	            var objResult=sendRequest(strUrl);
	            // alert("obj "+objResult.result);
				if(objResult.result==1){
					var list = "";
					var total ="";
					// alert(objResult.sale.length+" length");
					for(var i = 0; i < objResult.sale.length; i++){
						list += "<li class='ui-li-static ui-body-inherit'>";
						list += "<h2>"+objResult.sale[i].pname+"</h2>";
						list += "<p>"+objResult.sale[i].price+"</p>";
						list += "<p>"+objResult.sale[i].qty+"</p></a></li>";
						total += (objResult.sale[i]['price'] * objResult.sale[i]['qty']);
					}
					$("#rec").html(list);
					var strUrl = "http://cs.ashesi.edu.gh/~csashesi/class2016/agatha-maison/MWC/response.php?cmd=10&sid="+id+"&total="+total;
				var objResult=sendRequest(strUrl);
				if(objResult.result==1){
					// alert(total+" ..total");
					$("#total").html("GHC "+total);
				}
				}
		}
		</script>
	</head>
	<body>
		<div data-role="page" id="pageone" data-theme="c">
			<div data-role="header">
				<h1>POS</h1>

				<div data-role="navbar">
					<ul>
						<li><a href="index.html" data-icon="shop" data-transition="pop">Dailies</a></li>
						<li><a href="transaction.html" data-icon="plus" class="ui-btn-active" data-transition="flip" >Transaction</a></li>
					</ul>
				</div>
			</div>

			<div role="main" class="ui-content">

				<form method="post">
					<div data-role="fieldcontain" >						
						<div>
							<label for="pnum">Phone Number</label>
							<input type="tel" name="pnum" placeholder="233123456789" id="pnum">
						</div>

						<div>
							<span>Date:</span>
							<span id="date"></span>
						</div>

						<div>
							<span>Time:</span>
							<span id="time"></span>
						</div>
						
						<a href="#popupQty" data-rel="popup" data-position-to="window" class="ui-shadow ui-btn ui-corner-all ui-btn-inline ui-btn-icon-left ui-icon-grid">Scan Item</a>
						<div id="btn">
						</div>
						<div data-role="popup" id="popupQty" data-theme="a" class="ui-corner-all">
						<a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a>
							<form>
								<div style="padding:10px 20px;">
									<h3>Enter quantity</h3>

									<div>
										<div><a href="#" data-role="button"data-inline="true" data-icon="grid" onclick="scan()">SCAN</a></div>
									</div>
									<div>
										<span><b>Product Name:</b></span>
										<span name="pname" id="pname"></span>
									</div>
									<div>
										<span><b>Product Price:</b></span>
										<span name="price" id="price"></span>
									</div>
									<div>
										<label for="qty" class="ui-hidden-accessible">Quantity:</label>
										<input type="number" name="qty" id="qty" value="" placeholder="quantity" data-theme="a">
									</div>
									
									<a href="#" data-role="button" class="ui-btn ui-corner-all ui-shadow ui-btn-b ui-btn-icon-left ui-icon-check" onclick="addSale()">Save</a>
								</div>
							</form>
						</div> 

						<div>
							<ul data-role="listview" data-split-icon="gear" data-split-theme="a" data-inset="true"  class="ui-listview ui-listview-inset ui-corner-all ui-shadow" id="rec">
							</ul>
						</div>

						<div id="total"></div>
					</div>
			</form>
			</div>
			<div data-role="footer">
				<h3>Inventory</h3>
			</div>
		</div>
	</body>
</html>